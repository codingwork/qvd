define(["module"],function(e){function r(e){return"text"!==e.tag}function n(e){return"object"==typeof e}function t(e,r,n){return e.splice(r,1),{from:r,key:n}}function l(e,n,t,l){if(t[l]=apply=t[l]||[],null==n)apply.push({from:e,operate:i.REMOVE});else if(r(e)&&r(n))if(e.tag===n.tag){var u=o(e.props,n.props);u&&apply.push({diff:u,operate:i.PROPS}),h(e,n,t,apply,l)}else apply.push({from:e,to:n,operate:i.REPLACE});else(r(e)||r(n)||e.text!==n.text)&&apply.push({from:e,to:n,operate:i.REPLACE})}function o(e,r){var t,l,u,p;for(t in e)if(t in r){if(l=e[t],u=r[t],l!==u)if(n(l)&&n(u)){var h=o(l,u);h&&(p=p||{},p[t]=h)}else p=p||{},p[t]=u}else p=p||{},p[t]=void 0;for(t in r)t in e||(p=p||{},p[t]=r[t]);return p}function u(e){for(var r,n={},t=[],l=e.length,o=0;l>o;o++)r=e[o],r.key?n[r.key]=o:t.push(o);return{keys:n,free:t}}function p(e,r){var n=u(r),l=n.keys,o=n.free;if(o.length===r.length)return{children:r,moves:null};var p=u(e),h=p.keys,s=p.free;if(s.length===e.length)return{children:r,moves:null};for(var f,i,y=[],a=0,k=o.length,c=0,g=0,v=e.length;v>g;g++)f=e[g],f.key?l.hasOwnProperty(f.key)?(i=l[f.key],y.push(r[i])):(i=g-c++,y.push(null)):k>a?(i=o[a++],y.push(r[i])):(i=g-c++,y.push(null));var E,d=a>=o.length?r.length:o[a],m=0;for(v=r.length;v>m;m++)E=r[m],E.key?h.hasOwnProperty(E.key)||y.push(E):m>=d&&y.push(E);for(var R,P,O=y.slice(),x=0,A=[],S=[],C=0;v>C;){for(P=r[C],R=O[x];null===R&&O.length;)A.push(t(O,x,null)),R=O[x];R&&R.key===P.key?(x++,C++):P.key?(R&&R.key&&l[R.key]!==C+1?(A.push(t(O,x,R.key)),R=O[x],R&&R.key===P.key?x++:S.push({key:P.key,to:C})):S.push({key:P.key,to:C}),C++):R&&R.key&&A.push(t(O,x,R.key))}for(;x<O.length;)R=O[x],A.push(t(O,x,R&&R.key));return A.length!==c||S.length?{children:y,moves:{removes:A,inserts:S}}:{children:y,moves:null}}function h(e,r,n,t,o){for(var u,h,s=e.children,f=p(s,r.children),y=f.children,a=s.length,k=y.length,c=a>k?a:k,g=0,g=0;c>g;g++)u=s[g],h=y[g],o+=1,u?l(u,h,n,o):h&&t.push({from:h,operate:i.INSERT});return f.moves&&t.push({operate:i.ORDER,from:e,to:f.moves}),t}function s(e,r,n){r=r||{},n=n||[];var t;return"text"===e?{tag:e,text:r}:("key"in r&&(t=r.key,delete r.key),{tag:e,props:r,children:n,key:t})}function f(e,r){var n={},t=[];t.a=e,l(e,r,n,0);for(var o=0;n[o];o++)n[o].length&&t.push(n[o]);return t}var i={REMOVE:1,INSERT:2,REPLACE:3,ORDER:4,PROPS:5};e.exports={h:s,diff:f,OPERATE:i}});